# .github/workflows/static_analysis.yml
# This workflow performs high-standard static analysis to catch logic, memory, and security errors.

name: Cppcheck Static Analysis

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    cppcheck:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v6 # Kept as v6 per your request

            - name: Install Cppcheck
              run: |
                  sudo apt-get update
                  sudo apt-get install -y cppcheck

            # 1. Integration: Problem Matcher
            # This allows GitHub to "read" the linter output and place red markers
            # directly on your code in the "Files Changed" tab.
            - name: Setup Problem Matcher
              run: echo "::add-matcher::.github/cppcheck-matcher.json"
              continue-on-error: true

            # 2. The Blocker: Strict Logic Analysis
            # - Targets only your project folders (src, lib, include) to avoid .pio/libdeps.
            # - Suppresses 'unusedFunction' to stop flagging Arduino framework functions (setup/loop).
            # - Enabled: warning, error, performance, portability (hides the 39 'Low' style issues).
            - name: Run Cppcheck Analysis (The Blocker)
              run: |
                  mkdir -p report
                  cppcheck --enable=warning,error,performance,portability --inline-suppr --std=c++11 --force \
                           --xml --xml-version=2 \
                           --suppress=unusedFunction \
                           --suppress=missingIncludeSystem --suppress=missingInclude \
                           --error-exitcode=1 \
                           src/ESP32/src/ src/ESP32/lib/ src/ESP32/include/ \
                           -I src/ESP32/include/ -I src/ESP32/src/ \
                           $(find src/ESP32/lib -type d -printf "-I %p " 2>/dev/null) \
                           2> cppcheck_report.xml

            # 3. User Feedback: Console Summary
            # This provides a human-readable list of logic errors in the GitHub Actions console.
            - name: Generate Console Output
              if: failure() || success()
              run: |
                  cppcheck --enable=warning,error,performance,portability --inline-suppr --std=c++11 --force \
                           --template="{file}:{line}:{column}: {severity}: {message}" \
                           --suppress=unusedFunction \
                           --suppress=missingIncludeSystem --suppress=missingInclude \
                           src/ESP32/src/ src/ESP32/lib/ src/ESP32/include/ \
                           -I src/ESP32/include/ -I src/ESP32/src/ \
                           $(find src/ESP32/lib -type d -printf "-I %p " 2>/dev/null)

            # 4. Visualization: HTML Dashboard
            # Converts the raw results into a detailed HTML website for deep-debugging.
            - name: Generate HTML Report
              if: always()
              run: |
                  cppcheck-htmlreport --file=cppcheck_report.xml \
                                      --report-dir=report \
                                      --source-dir=. \
                                      --title="High Standard ESP32 Analysis"

            # 5. Storage: Artifact Upload
            # Saves the HTML report for 14 days, accessible via the Actions tab.
            - name: Upload HTML Artifact
              if: always()
              uses: actions/upload-artifact@v6 # Kept as v6 per your request
              with:
                  name: cppcheck-dashboard
                  path: report/
                  retention-days: 14