name: Cppcheck Static Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  cppcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run Cppcheck Analysis
        # We output to XML for the HTML report and a text file for the Annotator
        run: |
          mkdir -p report
          cppcheck --enable=all --inline-suppr --force --xml --xml-version=2 \
                   --suppress=missingIncludeSystem --suppress=unusedFunction \
                   --suppress=cstyleCast --suppress=missingInclude \
                   src/ESP32/src/ src/ESP32/lib/ \
                   -I src/ESP32/include/ -I src/ESP32/src/ \
                   $(find src/ESP32/lib -type d -printf "-I %p ") \
                   2> cppcheck_report.xml

      - name: Generate HTML Report
        run: |
          mkdir -p report
          
          # 1. Output to console for GitHub Annotations (Human Readable)
          cppcheck --enable=all --inline-suppr --force --template=gcc \
                   --suppress=missingIncludeSystem --suppress=unusedFunction \
                   --suppress=cstyleCast --suppress=missingInclude \
                   src/ESP32/src/ src/ESP32/lib/ \
                   -I src/ESP32/include/ -I src/ESP32/src/ \
                   $(find src/ESP32/lib -type d -printf "-I %p ")

          # 2. Output to XML for the HTML Dashboard
          cppcheck --enable=all --inline-suppr --force --xml --xml-version=2 \
                   --suppress=missingIncludeSystem --suppress=unusedFunction \
                   --suppress=cstyleCast --suppress=missingInclude \
                   src/ESP32/src/ src/ESP32/lib/ \
                   -I src/ESP32/include/ -I src/ESP32/src/ \
                   $(find src/ESP32/lib -type d -printf "-I %p ") \
                   2> cppcheck_report.xml

          # 3. Generate the Dashboard
          cppcheck-htmlreport --file=cppcheck_report.xml \
                              --report-dir=report \
                              --source-dir=. \
                              --title="ESP32 Analysis Results"

      - name: Upload HTML Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-dashboard
          path: report/

      - name: Create GitHub Annotations
        uses: cpp-linter/cppcheck-action@v2
        with:
          # This reads the XML we already generated and highlights the PR code
          output_file: cppcheck_report.xml
          # Set to 'true' if you want the build to fail on errors
          fail_on_error: true
