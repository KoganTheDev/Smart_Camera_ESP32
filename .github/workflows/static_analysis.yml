name: Cppcheck Static Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  cppcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Setup Problem Matcher
        run: echo "::add-matcher::.github/cppcheck-matcher.json"

      - name: Run Cppcheck Analysis
        # We use 'continue-on-error' or '|| true' so the UI injection steps still run even if bugs are found
        run: |
          mkdir -p report
          
          # 1. Console Output (for PR Annotations)
          cppcheck --enable=all --inline-suppr --force --template=gcc \
                   --suppress=missingIncludeSystem --suppress=unusedFunction \
                   --suppress=cstyleCast --suppress=missingInclude \
                   src/ESP32/src/ src/ESP32/lib/ \
                   -I src/ESP32/include/ -I src/ESP32/src/ \
                   $(find src/ESP32/lib -type d -printf "-I %p ") || true

          # 2. XML Output (for HTML Report)
          cppcheck --enable=all --inline-suppr --force --xml --xml-version=2 \
                   --suppress=missingIncludeSystem --suppress=unusedFunction \
                   --suppress=cstyleCast --suppress=missingInclude \
                   src/ESP32/src/ src/ESP32/lib/ \
                   -I src/ESP32/include/ -I src/ESP32/src/ \
                   $(find src/ESP32/lib -type d -printf "-I %p ") \
                   2> cppcheck_report.xml || true

          # 3. Generate the Dashboard
          cppcheck-htmlreport --file=cppcheck_report.xml \
                              --report-dir=report \
                              --source-dir=. \
                              --title="ESP32 Analysis Results"

      - name: Modernize Report UI
        run: |
          # Injecting ultra-modern CSS and fonts into all generated HTML files
          find report -name "*.html" -exec sed -i '/<head>/a \
          <link rel="preconnect" href="https://fonts.googleapis.com"> \
          <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet"> \
          <style> \
            /* Global Reset & Background */ \
            body { font-family: "Inter", sans-serif !important; background-color: #0f172a !important; color: #f8fafc !important; margin: 0 !important; display: flex !important; } \
            \
            /* Sidebar Styling */ \
            #left_column { background: #1e293b !important; border-right: 1px solid #334155 !important; padding: 20px !important; min-width: 250px !important; height: 100vh !important; overflow-y: auto !important; position: fixed !important; } \
            #left_column a { color: #38bdf8 !important; text-decoration: none !important; display: block !important; padding: 8px 12px !important; border-radius: 6px !important; transition: all 0.2s !important; margin-bottom: 4px !important; font-size: 0.9rem !important; } \
            #left_column a:hover { background: #334155 !important; color: #7dd3fc !important; } \
            \
            /* Main Content Area */ \
            #right_column { margin-left: 280px !important; padding: 40px !important; width: calc(100% - 320px) !important; } \
            h1 { font-weight: 600 !important; letter-spacing: -0.025em !important; color: #ffffff !important; margin-bottom: 30px !important; } \
            \
            /* Modern Table Styling */ \
            table { border-collapse: separate !important; border-spacing: 0 !important; width: 100% !important; border: 1px solid #334155 !important; border-radius: 12px !important; overflow: hidden !important; background: #1e293b !important; margin-top: 20px !important; } \
            th { background-color: #0f172a !important; color: #94a3b8 !important; padding: 14px 16px !important; text-align: left !important; font-size: 0.75rem !important; text-transform: uppercase !important; letter-spacing: 0.1em !important; } \
            td { padding: 12px 16px !important; border-top: 1px solid #334155 !important; color: #cbd5e1 !important; } \
            tr:hover td { background-color: #334155 !important; } \
            \
            /* Code Editor Look */ \
            .highlight { background: #450a0a !important; border-radius: 4px !important; padding: 2px 5px !important; border-left: 4px solid #ef4444 !important; } \
            pre { \
              font-family: "Fira Code", monospace !important; \
              background: #000000 !important; \
              color: #e2e8f0 !important; \
              padding: 20px !important; \
              border-radius: 12px !important; \
              border: 1px solid #334155 !important; \
              line-height: 1.6 !important; \
              box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06) !important; \
              overflow-x: auto !important; \
            } \
            \
            /* Line Numbers Fix */ \
            .lineno { \
              color: #475569 !important; \
              background: transparent !important; \
              padding-right: 20px !important; \
              border-right: 1px solid #334155 !important; \
              margin-right: 15px !important; \
              user-select: none !important; \
            } \
            \
            /* Error Labels */ \
            .error { color: #f43f5e !important; font-weight: 600 !important; } \
            .warning { color: #fbbf24 !important; } \
            .style { color: #38bdf8 !important; } \
          </style>' {} +
          
      - name: Upload HTML Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-dashboard
          path: report/
          retention-days: 14
