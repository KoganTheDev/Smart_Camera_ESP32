name: Cppcheck Static Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  cppcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Setup Problem Matcher
        run: echo "::add-matcher::.github/cppcheck-matcher.json"
        continue-on-error: true

      - name: Run Cppcheck Analysis (The Blocker)
        # STRICT MODE: Removed unusedFunction and cstyleCast suppressions.
        # Now fails on Style, Performance, and Portability to ensure high standards.
        run: |
          mkdir -p report
          cppcheck --enable=all --inline-suppr --std=c++11 --force \
                   --xml --xml-version=2 \
                   --suppress=missingIncludeSystem --suppress=missingInclude \
                   --error-exitcode=1 \
                   src/ESP32/src/ src/ESP32/lib/ src/ESP32/include/ \
                   -I src/ESP32/include/ -I src/ESP32/src/ \
                   $(find src/ESP32/lib -type d -printf "-I %p " 2>/dev/null) \
                   2> cppcheck_report.xml

      - name: Generate Console Output
        # This step runs whether the blocker passed or failed to provide annotations.
        if: failure() || success()
        run: |
          cppcheck --enable=all --inline-suppr --std=c++11 --force \
                   --template="{file}:{line}:{column}: {severity}: {message}" \
                   --suppress=missingIncludeSystem --suppress=missingInclude \
                   src/ESP32/src/ src/ESP32/lib/ src/ESP32/include/ \
                   -I src/ESP32/include/ -I src/ESP32/src/ \
                   $(find src/ESP32/lib -type d -printf "-I %p " 2>/dev/null)

      - name: Generate HTML Report
        if: always()
        run: |
          cppcheck-htmlreport --file=cppcheck_report.xml \
                              --report-dir=report \
                              --source-dir=. \
                              --title="High Standard ESP32 Analysis"

      - name: Upload HTML Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-dashboard
          path: report/
          retention-days: 14
