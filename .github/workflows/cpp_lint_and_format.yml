# .github/workflows/cpp_lint_and_format.yml
# This workflow ensures the code is logically sound and perfectly formatted.
# If the formatting is off, it FIXES the code and commits it back to your branch.

name: Style and Logic Guard

on: [push, pull_request]

jobs:
    format-and-check:
        runs-on: ubuntu-latest
        permissions:
            # Crucial: Allows the bot to push "style fix" commits back to your repo
            contents: write 
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.9"

            - name: Install PlatformIO and Clang-Format
              run: |
                  pip install -U platformio
                  sudo apt-get install -y clang-format

            # 1. Logic Check
            # Runs Cppcheck via PlatformIO. It ensures you haven't introduced 
            # critical bugs (memory leaks, etc.)
            - name: Run Cppcheck
              run: pio check --fail-on-warnings

            # 2. Format Fixer (Silent cleaning)
            # Scans all source folders and applies your project's style rules.
            - name: Run Clang-Format
              run: find src include lib -iname *.h -o -iname *.cpp -o -iname *.hpp | xargs clang-format -i

            # 3. Automation: Push fixes back
            # If Clang-Format changed any files, this step detects it and 
            # creates a new commit automatically.
            - name: Commit changes
              uses: stefanzweifel/git-auto-commit-action@v7
              with:
                  commit_message: "GITHUB-WORKFLOW: auto-formatted code"