# .github/workflows/cpp_lint_and_format.yml
# This workflow ensures the code is logically sound and perfectly formatted.
# It automatically fixes style issues based on your .clang-format rules.

name: CPP Linter & Formatter

on: [push, pull_request]

jobs:
    format-and-check:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            # 1. Fetch the code
            - name: Checkout Code
              uses: actions/checkout@v4

            # 2. Setup Python environment
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.9"

            # 3. Install PlatformIO for logic checks and Clang-Format for styling
            - name: Install PlatformIO and Clang-Format
              run: |
                  pip install -U platformio
                  sudo apt-get install -y clang-format

            # 4. Logic Check (Mental Peace)
            # Targets the ESP32 subfolder and only reports serious issues.
            - name: Run PlatformIO Check
              working-directory: src/ESP32
              run: pio check --severity=high --severity=medium

            # 5. Format Fixer (Silent cleaning)
            # Uses your .clang-format file to fix braces
            - name: Run Clang-Format
              run: |
                  find src/ESP32/src src/ESP32/include src/ESP32/lib -iname *.h -o -iname *.cpp -o -iname *.hpp | xargs clang-format -i

            # 6. Automation: Push fixes back
            # If the code didn't match your style, the robot commits the fixes.
            - name: Commit changes
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  commit_message: "GITHUB-ACTIONS: auto-formmated code"
