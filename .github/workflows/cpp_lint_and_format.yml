# .github/workflows/cpp_lint_and_format.yml
# This workflow ensures the code is logically sound and perfectly formatted.
# If the formatting is off, it FIXES the code and commits it back to your branch.

name: CPP Linter & Formmater

on: [push, pull_request]

jobs:
    format-and-check:
        runs-on: ubuntu-latest
        permissions:
            contents: write 
        steps:
            # 1. Fetch the code
            - name: Checkout Code
              uses: actions/checkout@v4

            # 2. Setup Python
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.9"

            # 3. Install Tools
            - name: Install PlatformIO and Clang-Format
              run: |
                  pip install -U platformio
                  sudo apt-get install -y clang-format

            # 4. Logic Check (Mental Peace - no local noise)
            - name: Run PlatformIO Check
              working-directory: src/ESP32
              run: pio check --severity=high --severity=medium

            # 5. Format Fixer (Silent cleaning)
            # This targets your nested code folders specifically.
            - name: Run Clang-Format
              run: |
                find src/ESP32/src src/ESP32/include src/ESP32/lib -iname *.h -o -iname *.cpp -o -iname *.hpp | xargs clang-format -i

            # 6. Automation: Push fixes back
            # If Clang-Format changed any files, this step detects it and 
            # creates a new commit automatically.
            - name: Commit changes
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  commit_message: "GITHUB-ACTIONS: auto-formatted code"